
{% extends "base.html" %}

{% block title %}Мой QR-код - MyBudget{% endblock %}
{% block page_title %}Поделиться профилем{% endblock %}

{% block content %}
<div class="max-w-md mx-auto">
    <!-- Header with Back Button -->
    <div class="mb-8 flex items-center justify-between">
        <a href="{% url 'accounts:profile' request.user.username %}" class="inline-flex items-center gap-2 text-sm font-black text-slate-400 uppercase tracking-widest hover:text-[#609988] transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            Назад
        </a>
    </div>

    <!-- QR Card -->
    <div class="card p-10 relative overflow-hidden text-center">
        <!-- Decoration Blur -->
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-40 h-40 bg-[#609988]/10 blur-[60px] rounded-full -mt-20"></div>

        <div class="relative space-y-8">
            <!-- User Info -->
            <div class="space-y-3">
                <img src="https://ui-avatars.com/api/?name=Aziz+Karimov&background=609988&color=fff&bold=true&size=128" 
                     class="w-20 h-20 rounded-[2rem] shadow-lg border-4 border-white mx-auto">
                <div>
                    <h3 class="text-xl font-black text-slate-800">{{ request.user.first_name }} {{ request.user.last_name }}</h3>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">MyBudget ID: FW-99283471</p>
                </div>
            </div>

            <!-- QR Code Container -->
            <div class="aspect-square w-full max-w-[200px] mx-auto bg-white p-4 rounded-3xl shadow-sm flex items-center justify-center relative overflow-hidden">
                <img src="data:image/png;base64,{{ user_qr }}" alt="QR Code" class="w-full h-full object-contain">
            </div>

            <!-- Share Actions -->
            <div class="grid grid-cols-1 gap-3">
                <button id="downloadQrBtn" class="w-full py-4 bg-[#609988] text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-teal-900/20 hover:bg-[#4d7a6d] transition-all flex items-center justify-center gap-3">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Скачать QR
                </button>

                <div class="grid grid-cols-2 gap-3">
                    <button id="copyLinkBtn" class="py-4 bg-slate-50 text-slate-600 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-100 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                        Копия ссылки
                    </button>
                    <button id="shareBtn" class="py-4 bg-slate-50 text-slate-600 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-100 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="share-2" class="w-3.5 h-3.5"></i>
                        Поделиться
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Info -->
    <div class="mt-8 text-center px-6">
        <p class="text-xs text-slate-400 font-medium leading-relaxed">
            Этот QR-код содержит только публичную информацию, необходимую для совершения переводов по системе <span class="text-[#609988] font-bold">MyBudget Pay</span>.
        </p>
    </div>
</div>
<script>
    document.getElementById('downloadQrBtn').addEventListener('click', function() {
        const qrImg = document.getElementById('qrImage');
        const imgData = qrImg.src;

        // Base64 → Blob
        const byteString = atob(imgData.split(',')[1]);
        const arrayBuffer = new ArrayBuffer(byteString.length);
        const intArray = new Uint8Array(arrayBuffer);
        for (let i = 0; i < byteString.length; i++) {
            intArray[i] = byteString.charCodeAt(i);
        }
        const blob = new Blob([intArray], { type: 'image/png' });

        // Download link yaratish
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = '{{ username }}_qr.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    document.getElementById('copyLinkBtn').addEventListener('click', function() {
        const profileUrl = window.location.href; // hozirgi sahifa URL
        navigator.clipboard.writeText(profileUrl)
            .then(() => alert('Ссылка скопирована!'))
            .catch(err => alert('Ошибка копирования')); 
    });
</script>

{% endblock %}


